library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
use IEEE.NUMERIC_STD.ALL;

entity M6809_Clock_Gen is
    Port (
        clk_4x : in  STD_LOGIC;  -- Input clock (4x frequency)
        reset  : in  STD_LOGIC;  -- Asynchronous reset
        mrdy   : in  STD_LOGIC;  -- Memory Ready (Low = Stretch Clocks)
        E      : out STD_LOGIC;  -- Enable clock
        Q      : out STD_LOGIC   -- Quadrature clock
    );
end M6809_Clock_Gen;

architecture Behavioral of M6809_Clock_Gen is
    signal count : unsigned(1 downto 0) := "00";
begin

    -- State Counter with Stretching Logic
    process(clk_4x, reset)
    begin
        if reset = '1' then
            count <= "00";
        elsif rising_edge(clk_4x) then
            -- Only advance the clock phases if MRDY is high
            if mrdy = '1' then
                count <= count + 1;
            end if;
            -- If mrdy is '0', count stays the same, stretching E and Q
        end if;
    end process;

    -- Output Logic (Same as before)
    -- This maintains the current state of E and Q while 'count' is frozen
    process(count)
    begin
        case count is
            when "00" =>
                Q <= '1'; E <= '0';
            when "01" =>
                Q <= '1'; E <= '1';
            when "10" =>
                Q <= '0'; E <= '1';
            when "11" =>
                Q <= '0'; E <= '0';
            when others =>
                Q <= '0'; E <= '0';
        end case;
    end process;

end Behavioral;